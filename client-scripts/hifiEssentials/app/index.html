<!DOCTYPE html>
<html>
	<head>
		<title>hifi essentials</title>
		<link href="https://fonts.googleapis.com/css?family=Roboto+Mono|Roboto:400,700" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="styles.css">
		<script src="Collapse.js"></script>
		<script src="WorldSelector.js"></script>
	</head>
	<body>
		<div id="top-bar">
			<a href="javascript:openSidebar()"><div id="top-bar-sidebar">
				<svg style="fill: rgba(29,31,33,0.4); top: 8px; left: 8px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
			</div></a><div id="top-bar-text"></div>
		</div>
		<div id="content">
			<div id="avatars" style="display: none;"></div>
			<div id="worlds" style="display: none; margin: -10px; height: calc(100vh - 50px); margin-bottom: -60px;"></div>
			<div id="scripts" style="display: none;"></div>
			<div id="settings" style="display: none; margin: 10px;">
				<h1>avatar</h1>
				<br>
				<div style="margin-left: 16px;">
					<table cellspacing="8px">
						<tr class="pointer" id="settings-disableCollisions">
							<td class="checkbox"></td>
							<td><h2 style="margin-left:8px"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.5 6c-2.61.7-5.67 1-8.5 1s-5.89-.3-8.5-1L3 8c1.86.5 4 .83 6 1v13h2v-6h2v6h2V9c2-.17 4.14-.5 6-1l-.5-2zM12 6c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/><rect fill="#fff" x="0" y="10.5" width="24" height="4"/><rect x="0" y="11.5" width="24" height="2"/></svg> disable collisions</h2></td>
						</tr>
						<tr class="pointer" id="settings-enableFlying">
							<td class="checkbox"></td>
							<td><h2 style="margin-left:8px"><svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-linecap="round" stroke-width="1.508" stroke="#000"><path d="M3.541 18.397c4.647.27 7.606-3.24 9.045-5.002M5.28 21.01c4.512-1.048 5.453-2.336 7.306-7.614M12.586 13.396s2.533-1.616 5.003-5.488M9.588 12.798c.338-.265 2.08-2.347 7.006-3.876" fill="none"/><circle cx="18.22" cy="5.2" r="2.221"/></svg> enable flying/jumping</h2></td>
						</tr>
					</table>
					<br>
					<h2 style="margin-left: 8px;">size</h2>
					<table cellspacing="8px">
						<tr class="pointer">
							<td class="button" id="settings-sizeBigger"><svg class="icon" style="fill:#fff;margin:0 -4px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> bigger</td>
							<td class="button" id="settings-sizeSmaller"><svg class="icon" style="fill:#fff;margin:0 -4px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg> smaller</td>
							<td class="button" id="settings-sizeDefault">1</td>
							<td><input id="settings-sizeNumber" type="number" style="width: 52px;"/></td>
						</tr>
					</table>
					<br>
					<h2 style="margin-left: 8px;">speed</h2>
					<table cellspacing="8px">
						<tr class="pointer">
							<td class="button" id="settings-speedFaster"><svg class="icon" style="fill:#fff;margin:0 -4px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> faster</td>
							<td class="button" id="settings-speedSlower"><svg class="icon" style="fill:#fff;margin:0 -4px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg> slower</td>
							<td class="button" id="settings-speedDefault">2.6</td>
							<td><input id="settings-speedNumber" type="number" style="width: 52px;"/></td>
						</tr>
					</table>
				</div>
				<br>
				<h1>graphics</h1>
				<br>
				<div style="margin-left: 16px;">
					<table cellspacing="8px">
						<tr class="pointer" id="settings-disableAntiAliasing">
							<td class="checkbox"></td>
							<td><h2 style="margin-left:8px"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="-0.5 -0.5 5 5"><path d="M0 0h1v1H0zM2 0h1v1H2zM1 1h1v1H1zM3 1h1v1H3zM0 2h1v1H0zM2 2h1v1H2zM1 3h1v1H1zM3 3h1v1H3z"/></svg> disable anti-aliasing</h2></td>
						</tr>
					</table>
				</div>
				<br>
				<p style="opacity: 0.6;">If a setting doesn't work, there might be a possibility that the script is outdated. You'll have to <b>reload hifiEssentials.js</b> in running scripts or <b>restart interface</b>.</p>
				<script type="text/javascript">
					[
						// avatar
						{id:"disableCollisions", event:"click", callback:()=>{changeSetting("disableCollisions")}},
						{id:"enableFlying", event:"click", callback:()=>{changeSetting("enableFlying")}},
							// size
							{id:"sizeSmaller", event:"click", callback:()=>{changeSetting("sizeSmaller")}},
							{id:"sizeBigger", event:"click", callback:()=>{changeSetting("sizeBigger")}},
							{id:"sizeDefault", event:"click", callback:e=>{
								changeSetting("sizeNumber", e.target.innerHTML)
							}},
							{id:"sizeNumber", event:"change", callback:e=>{
								let n = parseFloat(e.target.value);
								if (n!=NaN) changeSetting("sizeNumber", n);
							}},
							{id:"sizeNumber", event:"keyup", callback:e=>{
								if (e.key == "Backspace") e.target.value = "";
							}},
							// speed
							{id:"speedFaster", event:"click", callback:()=>{changeSetting("speedFaster")}},
							{id:"speedSlower", event:"click", callback:()=>{changeSetting("speedSlower")}},
							{id:"speedDefault", event:"click", callback:e=>{
								changeSetting("speedNumber", e.target.innerHTML)
							}},
							{id:"speedNumber", event:"change", callback:e=>{
								let n = parseFloat(e.target.value);
								if (n!=NaN) changeSetting("speedNumber", n);
							}},
							{id:"speedNumber", event:"keyup", callback:e=>{
								if (e.key == "Backspace") e.target.value = "";
							}},
						// graphics
						{id:"disableAntiAliasing", event:"click", callback:()=>{changeSetting("disableAntiAliasing")}},
					].forEach(setting=>{

						document.getElementById("settings-"+setting.id).addEventListener(setting.event, setting.callback);

					});
				</script>
			</div>
		</div>
		<div id="sidebar">
			<div id="sidebar-background" style="background-image: url(assets/sakura.gif);"></div>
			<div id="sidebar-background" style="top: 75%; background: linear-gradient(180deg, rgba(29,31,33,0),rgba(29,31,33,1))"></div>
			<div id="sidebar-content">
				<img id="logo" src="assets/logo.svg"><br>
				<img id="cutelab" src="assets/cutelab.svg">
				<br>
				<a href="javascript:changePage('avatars')">
					<div id="sidebar-button" class="avatars" style="background-color: #00bcd4">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.5 6c-2.61.7-5.67 1-8.5 1s-5.89-.3-8.5-1L3 8c1.86.5 4 .83 6 1v13h2v-6h2v6h2V9c2-.17 4.14-.5 6-1l-.5-2zM12 6c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>
						<h2>avatars</h2>
					</div>
				</a>
				<a href="javascript:changePage('worlds')">
					<div id="sidebar-button" class="worlds" style="background-color: #8bc34a">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
						<h2>worlds</h2>
					</div>
				</a>
				<a href="javascript:changePage('scripts')">
					<div id="sidebar-button" class="scripts" style="background-color: #ff9800">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
						<h2>scripts</h2>
					</div>
				</a>
				<a href="javascript:changePage('settings')">
					<div id="sidebar-button" class="settings" style="background-color: #e91e63">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M15.95 10.78c.03-.25.05-.51.05-.78s-.02-.53-.06-.78l1.69-1.32c.15-.12.19-.34.1-.51l-1.6-2.77c-.1-.18-.31-.24-.49-.18l-1.99.8c-.42-.32-.86-.58-1.35-.78L12 2.34c-.03-.2-.2-.34-.4-.34H8.4c-.2 0-.36.14-.39.34l-.3 2.12c-.49.2-.94.47-1.35.78l-1.99-.8c-.18-.07-.39 0-.49.18l-1.6 2.77c-.1.18-.06.39.1.51l1.69 1.32c-.04.25-.07.52-.07.78s.02.53.06.78L2.37 12.1c-.15.12-.19.34-.1.51l1.6 2.77c.1.18.31.24.49.18l1.99-.8c.42.32.86.58 1.35.78l.3 2.12c.04.2.2.34.4.34h3.2c.2 0 .37-.14.39-.34l.3-2.12c.49-.2.94-.47 1.35-.78l1.99.8c.18.07.39 0 .49-.18l1.6-2.77c.1-.18.06-.39-.1-.51l-1.67-1.32zM10 13c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3z"/></svg>
						<h2>settings</h2>
					</div>
				</a>
				<br>
				<div style="opacity: 0.6;">
					<p><b>Thank you for using our app!</b> <svg style="fill: #f44336" class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></p>
					<br>
					<p>Feel free to send a message to <span style="font-family: 'Roboto Mono', monospace;">Maki#4845</span> on Discord if you have any queries or suggestions!</p>
				</div>
				<img id="aaahembarassing" src="assets/caitlyn-maki.png">
			</div>
		</div>
		<script type="text/javascript">
			var elTopBarSidebar = document.getElementById("top-bar-sidebar"); 
			var elTopBarText = document.getElementById("top-bar-text"); 
			var elContent = document.getElementById("content"); 
			var elSidebar = document.getElementById("sidebar");
			var elSidebarContent = document.getElementById("sidebar-content");

			elSidebar.addEventListener("click", e=>{ // closing sidebar
				if (e.target.id != "sidebar-background") return;
				if (!selectedPage) return;
				closeSidebar();
			});

			function changeTopBar(text, color) {
				let div = document.createElement("div");
				div.innerHTML = text;
				div.style.opacity = "0";

				let oldDiv = elTopBarText.children[0] 
				if (oldDiv) oldDiv.style.opacity = "0";
				
				elTopBarText.style.backgroundColor = color;
				elTopBarText.appendChild(div);
				setTimeout(()=>{
					if (oldDiv) oldDiv.remove();
					div.style.opacity = "1"; 
				}, 200);
			}

			var sidebarOpen = true;

			function closeSidebar() {
				if (!sidebarOpen) return;
				sidebarOpen = false;

				elSidebarContent.style.left = "-300px";
				setTimeout(()=>{
					elSidebar.style.opacity = "0";
					setTimeout(()=>{
						elSidebar.style.display = "none";
					}, 200)
				}, 100)
			}

			function openSidebar() {
				if (sidebarOpen) return;
				sidebarOpen = true;

				elSidebar.style.opacity = "0";
				elSidebar.style.display = "block";
				elSidebarContent.style.left = "-300px";
				setTimeout(()=>{
					elSidebar.style.opacity = "1";
					setTimeout(()=>{
						elSidebarContent.style.left = "0";
					}, 100);
				}, 10);
			}

			function toggleSidebar() {
				if (sidebarOpen) {
					closeSidebar();
				} else {
					openSidebar();
				}
			}

			var pages = [
				"avatars",
				"worlds",
				"scripts",
				"settings",
			]

			var pageEls = pages.map(id=>document.getElementById(id));
			var selectedPage = undefined;

			function changePage(newPage) {
				if (selectedPage == newPage) return closeSidebar();

				// find new page
				selectedPage = newPage;
				newPage = document.getElementById(newPage);
				if (!newPage) return;

				// update page, close sidebar and other pages
				if (window.qt) {
					switch (selectedPage) {
						case "settings": emitEvent("updateSettings"); break; 
						case "scripts": emitEvent("updateScripts"); break; 
					}
				}

				closeSidebar();

				let otherPageOpen = false;
				pageEls.forEach(page=>{
					if (page.style.display == "none") return;
					otherPageOpen = true;

					page.style.opacity = "0";
					setTimeout(()=>{
						page.style.display = "none";
					}, 200);
				});

				// open new page
				function openNewPage() {

					newPage.style.display = "block";
					newPage.style.opacity = "0";
					setTimeout(()=>{
						newPage.style.opacity = "1";
					}, 10);
				}
				
				if (otherPageOpen) {
					setTimeout(()=>{ openNewPage(); }, 200);
				} else {
					openNewPage();
				}

				// change top bar to match button
				let pageButton = document.querySelector("#sidebar-content ."+selectedPage);
				changeTopBar(
					pageButton.innerHTML,
					pageButton.style.backgroundColor
				);
			}

			function setClassToEl(element, className, active) {
				element.className = element.className.replace(className, "").trim();
				if (active) element.className = element.className+" "+className;
			}

			if (window.qt) {
				var _GET = {};
				if (window.location.search.length>1) {
					window.location.search.substr(1).split("&").forEach(p=>{
						p = p.split("=");
						_GET[p[0]] = p[1];
					});
				}

				var uuid = decodeURI(_GET.uuid);
				function emitEvent(key, value) {
					EventBridge.emitWebEvent(JSON.stringify({
						key: key, value: value||"",
						uuid: uuid,
					}));
				}

				function changeAvatar(name, url) {
					emitEvent("changeAvatar", {
						name: name,
						url: url,
					});
				}

				function changeSetting(key, value) {
					emitEvent("changeSetting", {
						key: key,
						value: value||undefined
					});
				}

				setTimeout(()=>{
					EventBridge.scriptEventReceived.connect(json=>{
						try { json = JSON.parse(json);
						} catch(err) {}
						if (json.uuid != uuid) return;

						switch (json.key) {
							case "updateSettings":
								setClassToEl(
									document.querySelector("#settings-disableCollisions .checkbox"),
									"active", json.value.disableCollisions);
								setClassToEl(
									document.querySelector("#settings-enableFlying .checkbox"),
									"active", json.value.enableFlying);

								document.getElementById("settings-sizeNumber").value = json.value.sizeNumber;
								document.getElementById("settings-speedNumber").value = json.value.speedNumber;

								setClassToEl(
									document.querySelector("#settings-disableAntiAliasing .checkbox"),
									"active", json.value.disableAntiAliasing);
							break;
							case "updateScripts":
								let scriptsEnabled = {};
								let scriptsChildren = document.querySelector("#scripts>table").children;

								for (let i=0; i<scriptsChildren.length; i+=1) {
									if (!scriptsChildren[i].id) continue;
									scriptsEnabled[
										scriptsChildren[i].id.replace("scripts-","")
									] = false;
								}

								// scriptsEnabled doesnt have the .js extensions

								let scriptsFilenames = Object.keys(scriptsEnabled);
								json.value.forEach(filename=>{
									filename = filename.replace(".js","");

									if (scriptsFilenames.indexOf(filename)>-1) {
										scriptsEnabled[filename] = true;
									} 
								});

								console.log(scriptsEnabled)

								scriptsFilenames.forEach(filename=>{
									setClassToEl(
										document.querySelector("#scripts-"+filename+" .checkbox"),
										"active", scriptsEnabled[filename]);
								});
							break;
						}
					});
					//emitEvent("updateSettings");
				}, 200);
			}

			// clicky hover sound effects
			var sounds = {
				mouseenter: "assets/sounds/ss-hover.ogg",
				mousedown: "assets/sounds/ss-click.ogg",
			}

			Object.values(sounds).forEach(sound=>{ new Audio(sound); }); // preload

			var loaded = false;
			document.addEventListener("readystatechange", e=>{
				if (loaded) return;
				if (e.target.readyState != "complete") return;
				loaded = true;
				
				["a", ".checkbox", ".button"].forEach(query=>{
					document.querySelectorAll(query).forEach(el=>{
						Object.keys(sounds).forEach(event=>{
							el.addEventListener(event, e=>{
								let sfx = new Audio(sounds[event]);
								sfx.volume = 0.05;
								sfx.play();
							});
						});
					});
				});
			});
		</script>
		<script type="text/javascript" src="content.js"></script>
	</body>
</html>